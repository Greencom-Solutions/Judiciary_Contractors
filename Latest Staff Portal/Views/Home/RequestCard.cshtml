@model dynamic
@{
    Layout = "~/Views/Shared/_LayoutPage1.cshtml";
}

<h4>Home/ContractorsRequest</h4>
<div class="card">
    <div class="padding">

        @*<div class="row filter-row">
                <div class="col-sm-4 col-xs-6">
                    <div class="form-group form-focus">
                        <label class="control-label">Seacrh by  Procurement Method</label>
                        <input type="text" class="form-control floating" />
                    </div>
                </div>
                <div class="col-sm-4 col-xs-6">
                    <div class="form-group form-focus">
                        <label class="control-label">Search by Regions</label>
                        <input type="text" class="form-control floating" />
                    </div>
                </div>
                <div class="col-sm-4 col-xs-6">
                    <a href="#" class="btn btn-success btn-block"> Search </a>
                </div>
            </div>*@


        <div class="row">

            <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">

                <div class="form-group">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-3">
                            <label for="no">Project No</label>
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-8 col-lg-9">
                            <input type="text" class="form-control" id="tender_No" disabled value="@Model.Tender_No" placeholder="" />
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-3">
                            <label for="contractorNo">Contractor No</label>
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-8 col-lg-9">
                            <select class="form-control" disabled id="contractorNo">
                                <option value="@Session["vendorNo"]"></option>

                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-3">
                            <label for="status">Status</label>
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-8 col-lg-9">
                            <input type="text" class="form-control" id="status" value="@Model.Status" disabled placeholder="" />
                        </div>
                    </div>
                </div>


            </div>

            <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
                <div class="form-group">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-3">
                            <label for="documentType">Request Type</label>
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-8 col-lg-9">

                            <input type="text" class="form-control" id="documentType" value="@Model.Document_Type" disabled placeholder="" />
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-3">
                            <label for="dateOfSubmission">Date of Submission</label>
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-8 col-lg-9">
                            <input type="text" class="form-control" id="dateOfSubmission" value="@Model.Date_of_Submittion" disabled placeholder="Enter Date of Submission" />
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-3">
                            <label for="ProjectName">Project Name</label>
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-8 col-lg-9">
                            <input type="text" class="form-control" id="ProjectName" value="@Model.Project_Name" disabled placeholder="Enter Date of Submission" />
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <br />

        <h5 style="border-bottom: 1px solid #b1acac;">Requests</h5>
        <div class="row">
            <div class="col-md-12">
                <div class="table-responsive">
                    <table class="table table-striped custom-table datatable">
                        <thead>
                            <tr>
                                <th>Request Number</th>
                                <th>Request Description</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="linesBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>



        <div class="text-right" style="margin-bottom: 2em;">
            <button class="btn btn-primary " onclick="addLines()">New</button>
        </div>
        <div class="text-right" style="margin-bottom: 2em;">
            <button class="btn btn-primary " onclick="submitRequestCard()">Submit Document</button>
        </div>
    </div>
    <!-- Modal Structure -->
    <div id="linesModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document" stylee="display:flex; min-height: calc(100% - 1rem);z-index:10">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Instruction Requests Lines</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="form-group col-xs-12 col-sm-12 col-md-6 col-lg-6">
                            <label for="ProjectNo">Project Number</label>
                            <input type="text" class="form-control" disabled value="@Model.Tender_No" id="ProjectNo" placeholder="" />
                        </div>
                        <div class="form-group col-xs-12 col-sm-12 col-md-6 col-lg-6">
                            <label for="requestDescription">Request Description</label>
                            <input type="text" required class="form-control" id="requestDescription" placeholder="" />
                        </div>
                        <div class="form-group col-xs-12 col-sm-12 col-md-6 col-lg-6">
                            <label for="AttachmentId">Attachment</label>
                            <input type="file" required class="form-control" id="attachmentId" placeholder="" />
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitLines()">Submit</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal Structure -->
    <div id="attachmentModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document" stylee="display:flex; min-height: calc(100% - 1rem);">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">New Request</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <iframe id="iframeId" style="width: 100%; height: 500px;"></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitLines()">Submit</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    function insert(base64String, docfilename) {
        //alert("Insert Started");
        
        var tendorNo = $("#ProjectNo").val();
        var description = $("#requestDescription").val();
        var attachment = base64String;
        var filename = docfilename;

        var data = {
            tendorNo: tendorNo,
            description: description,
            attachment: attachment,
            filename: filename
        };

        $.ajax({
            url: "/Home/InsertInstructionRequestLines",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json"
        }).done(function (status) {
            var registerstatus = status.split('*');
            status = registerstatus[0];
            console.log(JSON.stringify(status));
            switch (status) {
                case "success":
                    Swal.fire({
                        title: "Success!",
                        text: "Lines Added Successfully!",
                        icon: "success"
                    }).then(function () {
                        $('#linesModal').modal('hide');
                        var docNo = $("#tender_No").val();
                        loadInstructionLines(docNo);
                    });
                    break;
                default:
                    Swal.fire({
                        title: "Error!!!",
                        text: status,
                        icon: "error"
                    });
            }
        }).fail(function (xhr, status, error) {
            Swal.fire({
                title: "Error!!!",
                text: "An unexpected error occurred: " + error,
                icon: "error"
            });
        });
    }


    function addLines() {
        $('#linesModal').modal('show');

    }

    function getB64Str(buffer) {
        var binary = '';
        var bytes = new Uint8Array(buffer);
        var len = bytes.byteLength;
        for (var i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    function openAttachments(docNo, document_id) {
        alert("docNo: " + docNo);
        alert("docID: " + document_id);

        $.ajax({
            url: '/Home/RetrieveAttachment',
            type: 'POST',
            data: JSON.stringify({
                Module: "PJM",
                DocumentNo: docNo,
                DocumentType: "Receipt",
                document_id: document_id
            }),
            contentType: 'application/json',
            success: function (response) {
                var base64Data = response;
                var iframe = document.getElementById('iframeId');
                iframe.src = 'data:application/pdf;base64,' + base64Data;
                $('#attachmentModal').modal('show');
            },
            error: function (xhr, status, error) {
                Swal.fire('Warning', 'Error occurred!', 'warning');
            }
        });
    }

    function submitRequestCard() {
        var tendorNo = $("#tender_No").val();
        var data = {
            docNo: tendorNo
        };

        $.ajax({
            url: "/Home/submitRequestCard",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                var splitResponse = response.split('*');
                var status = splitResponse[0];
                var message = splitResponse[1];

                console.log("Status: " + status);

                switch (status) {
                    case "success":
                        Swal.fire({
                            title: "Success!",
                            text: message || "Request Added Successfully!",
                            icon: "success"
                        }).then((result) => {
                            window.location.href = "/Home/RequestCard?tendorNo=" + docNo;
                        });
                        break;
                    default:
                        Swal.fire({
                            title: "Error!!!",
                            text: message || "An unexpected error occurred.",
                            icon: "error"
                        });
                        break;
                }
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
                Swal.fire({
                    title: "Error!",
                    text: "An error occurred while submitting the request.",
                    icon: "error"
                });
            }
        });
    }

    function loadInstructionLines(docNo) {
        var data = {
            docNo: docNo

        };

        $.ajax({
            url: "/Home/InstructionLines",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.status && data.status === "danger") {
                    alert("Error: " + data.message);
                } else {
                    //alert(data);
                    var linesBody = $('#linesBody');
                    linesBody.empty(); // Clear existing rows

                    $.each(data, function (index, line) {
                        var row = '<tr>' +
                            '<td>' + line.Line_No + '</td>' +
                            '<td>' + line.Request_Description + '</td>' +
                            '<td><a class="btn btn-success" onclick="openAttachments(\'' + docNo + '\', \'' + line.DocumentID + '\')">' +
                            '<i class="fa fa-share m-r-10"></i>View Attachment</a></td>' +
                            '</tr>';
                        linesBody.append(row);
                    });
                }
            },
            error: function (xhr, status, error) {
                console.log(error);
                alert("An error occurred while loading instruction lines.");
            }
        });


    }
    function submitLines() {

        //var fileInput = $("#attachmentId").val();
        var fileInput = document.getElementById("attachmentId");
        var files = fileInput.files;
        var filetype;
        if (files.length) {
            var file = files[0];
            if (file.size > 10000000) {
                Swal.fire('Warning', 'Please only files less than 10MB allowed. Thanks!!', 'warning');
            }
            else {
                alert("started1");
                var blob = file.slice();
                filetype = file.type;
                docfilename = file.name;
                var reader = new FileReader();
                alert("started2");
                reader.onloadend = function (evt) {
                    if (evt.target.readyState == FileReader.DONE) {
                        var cont = evt.target.result
                        var base64String = getB64Str(cont);
                        insert(base64String, docfilename);
                        alert("done")
                    }

                };
                reader.readAsArrayBuffer(blob);
            }
        }

    }

    $(document).ready(function () {
        var docNo = $("#tender_No").val();

        if (docNo) {
            loadInstructionLines(docNo);
        }
    });

</script>
